parchment.transcript={sessionId:(new Date).getTime()+""+Math.ceil(Math.random()*1E3),command:{input:"",timestamp:0},output:"",statusline:"",window:0,turncount:0,inputcount:0,outputcount:1,styles:"",saveUrl:"",story:"",optOut:typeof getUrlVars().feedback!="undefined"&&getUrlVars().feedback!="1",serverOffline:false,send:function(d,c,a){var b=jQuery;if(this.collectTranscripts()){if(typeof d!="undefined")this.window=d;if(typeof c!="undefined")this.styles=c;if(typeof a!="undefined")this.output=a;d=b.toJSON({session:this.sessionId,
log:{inputcount:this.inputcount,outputcount:this.outputcount,input:this.command.input,output:this.output,window:this.window,styles:this.styles,timestamp:(new Date).getTime()}});b.ajax({type:"POST",url:this.saveUrl,data:{data:d}});this.output="";this.outputcount++}},collectTranscripts:function(){if(this.saveUrl==""||this.optOut||this.serverOffline)return false;return true},initialize:function(d){var c=this,a=jQuery;if(typeof d=="string")c.saveUrl=d;if(c.story==""){if(typeof parchment.options.default_story!=
"undefined"&&parchment.options.default_story!="")c.story=parchment.options.default_story;if(!parchment.options.lock_story&&typeof getUrlVars().story!="undefined"&&getUrlVars().story!="")c.story=getUrlVars().story}if(c.story=="")c.story="(unknown)";else console.log("story: "+c.story);if(!c.collectTranscripts())return false;d=a.toJSON({session:c.sessionId,start:{story:c.story,interpreter:"Parchment",browser:a.browser.name+" "+a.browser.version+" "+a.os.name}});a.ajax({type:"POST",url:c.saveUrl,data:{data:d},
error:function(){c.serverOffline=true},success:function(b){if(b.toLowerCase()!="ok")c.serverOffline=true}});return true},charName:function(d){switch(d){case 8:return"<backspace>";case 9:return"<tab>";case 13:return"<enter>";case 27:return"<esc>";case 32:return"<space>";case 37:return"<left>";case 38:return"<up>";case 39:return"<right>";case 40:return"<down>";case 46:return"<del>";default:return String.fromCharCode(d)}}};
jQuery(document).ready(function(d){d(document).bind("LineInput",function(a){parchment.transcript.command=a;parchment.transcript.inputcount++});d(document).bind("CharInput",function(a){parchment.transcript.command=a;parchment.transcript.command.input=parchment.transcript.charName(a.input.keyCode);parchment.transcript.inputcount++});d(document).bind("TextOutput",function(a){a.output.window==0&&parchment.transcript.send(a.output.window,a.output.styles,a.output.text)});d(document).bind("GlkOutput",function(a){for(var b=
0;b<a.output.size();++b){console.log("i"+b+": "+a.output[b].toSource());for(var e=0;e<a.output[b].text.size();++e){parchment.transcript.styles="";parchment.transcript.output="\n";if(typeof a.output[b].text[e].content!="undefined")for(var f=0;f<a.output[b].text[e].content.size();f+=2){parchment.transcript.styles=a.output[b].text[e].content[f];parchment.transcript.output=a.output[b].text[e].content[f+1];if(f==a.output[b].text[e].content.size()-2)parchment.transcript.output+="\n";parchment.transcript.send()}else parchment.transcript.send()}}});
var c=function(){Console.prototype.renderHtml=function(){for(var a="",b="",e=0;e<this.height;e++){for(var f=null,g=0;g<this.width;g++){if(this._styles[e][g]!==f){if(f!==null){parchment.transcript.send(1,f,b.replace(/\&nbsp\;/gi," "));b="";a+="</span>"}f=this._styles[e][g];if(f!==null)a+='<span class="'+f+'">'}a+=this._characters[e][g];b+=this._characters[e][g]}if(f!==null){a+="</span>";parchment.transcript.send(1,f,b.replace(/\&nbsp\;/gi," ")+"\n");b=""}a+="<br/>"}return a};d(document).unbind("TextOutput",
c)};d(document).bind("TextOutput",c)});function getUrlVars(){for(var d=[],c,a=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),b=0;b<a.length;b++){c=a[b].split("=");d.push(c[0]);d[c[0]]=c[1]}return d};
