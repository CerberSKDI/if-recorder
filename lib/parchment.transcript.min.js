parchment.transcript={sessionId:(new Date).getTime()+""+Math.ceil(Math.random()*1E3),command:{input:"",timestamp:0},output:"",cache:[],statusline:"",window:0,turncount:0,inputcount:0,outputcount:1,styles:"",saveUrl:"",story:"",optOut:typeof getUrlVars().feedback!="undefined"&&getUrlVars().feedback!="1",serverOffline:false,send:function(d,b,a,c){if(this.collectTranscripts()){if(typeof d!="undefined")this.window=d;if(typeof b!="undefined")this.styles=b;if(typeof a!="undefined")this.output=a;d={session:this.sessionId,
log:{inputcount:this.inputcount,outputcount:this.outputcount,input:this.command.input,output:this.output,window:this.window,styles:this.styles,timestamp:(new Date).getTime()}};if(c)this.cache.push(d);else{c=d;if(this.cache.length>0){c=this.cache.length;c.push(d);this.cache=[]}jQuery.ajax({type:"POST",url:this.saveUrl,data:{data:c}})}this.output="";this.outputcount++}},sendCache:function(){if(this.collectTranscripts()&&this.cache.length>0){jQuery.ajax({type:"POST",url:this.saveUrl,data:{data:this.cache}});
this.cache=[]}},collectTranscripts:function(){if(this.saveUrl==""||this.optOut||this.serverOffline)return false;return true},initialize:function(d){var b=this;if(typeof d=="string")b.saveUrl=d;if(b.story==""){if(typeof parchment.options.default_story!="undefined"&&parchment.options.default_story!="")b.story=parchment.options.default_story;if(!parchment.options.lock_story&&typeof getUrlVars().story!="undefined"&&getUrlVars().story!="")b.story=getUrlVars().story}if(b.story=="")b.story="(unknown)";else console.log("story: "+
b.story);if(!b.collectTranscripts())return false;jQuery.ajax({type:"POST",url:b.saveUrl,data:{data:{session:b.sessionId,start:{story:b.story,interpreter:"Parchment",browser:jQuery.browser.name+" "+jQuery.browser.version+" "+jQuery.os.name}}},error:function(){b.serverOffline=true},success:function(a){if(a.toLowerCase()!="ok")b.serverOffline=true}});return true},charName:function(d){switch(d){case Event.KEY_BACKSPACE:return"<backspace>";case 4294967289:return"<backspace/delete>";case Event.KEY_TAB:case 4294967287:return"<tab>";
case 13:case 4294967290:return"<enter>";case Event.KEY_ESC:case 4294967288:return"<esc>";case 32:return"<space>";case Event.KEY_LEFT:case 4294967294:return"<left>";case Event.KEY_UP:case 4294967292:return"<up>";case Event.KEY_RIGHT:case 4294967293:return"<right>";case Event.KEY_DOWN:case 4294967291:return"<down>";case 46:return"<del>";case Event.KEY_PAGEUP:case 4294967286:return"<pgup>";case Event.KEY_PAGEDOWN:case 4294967285:return"<pgdown>";case Event.KEY_HOME:case 4294967284:return"<home>";case Event.KEY_END:case 4294967283:return"<end>";
case 4294967279:return"<F1>";case 4294967278:return"<F2>";case 4294967277:return"<F3>";case 4294967276:return"<F4>";case 4294967275:return"<F5>";case 4294967274:return"<F6>";case 4294967273:return"<F7>";case 4294967272:return"<F8>";case 4294967271:return"<F9>";case 4294967270:return"<F10>";case 4294967269:return"<F11>";case 4294967268:return"<F12>";default:return String.fromCharCode(d)}}};
jQuery(document).ready(function(d){d(document).bind("LineInput",function(a){parchment.transcript.command=a;parchment.transcript.inputcount++});d(document).bind("CharInput",function(a){parchment.transcript.command=a;parchment.transcript.command.input=parchment.transcript.charName(a.input.keyCode);parchment.transcript.inputcount++});d(document).bind("TextOutput",function(a){a.output.window==0&&parchment.transcript.send(a.output.window,a.output.styles,a.output.text)});d(document).bind("GlkOutput",function(a){if(a.output!=
undefined){for(var c=0;c<a.output.length;++c)for(var e=0;e<a.output[c].text.length;++e){parchment.transcript.styles="";parchment.transcript.output="\n";if(typeof a.output[c].text[e].content!="undefined")for(var f=0;f<a.output[c].text[e].content.size();f+=2){parchment.transcript.styles=a.output[c].text[e].content[f];parchment.transcript.output=a.output[c].text[e].content[f+1];if(f==a.output[c].text[e].content.size()-2)parchment.transcript.output+="\n";parchment.transcript.send(parchment.transcript.window,
parchment.transcript.styles,parchment.transcript.output,true)}else parchment.transcript.send(parchment.transcript.window,parchment.transcript.styles,parchment.transcript.output,true)}parchment.transcript.sendCache()}});var b=function(){Console.prototype.renderHtml=function(){for(var a="",c="",e=0;e<this.height;e++){for(var f=null,g=0;g<this.width;g++){if(this._styles[e][g]!==f){if(f!==null){parchment.transcript.send(1,f,c.replace(/\&nbsp\;/gi," "));c="";a+="</span>"}f=this._styles[e][g];if(f!==null)a+=
'<span class="'+f+'">'}a+=this._characters[e][g];c+=this._characters[e][g]}if(f!==null){a+="</span>";parchment.transcript.send(1,f,c.replace(/\&nbsp\;/gi," ")+"\n");c=""}a+="<br/>"}return a};d(document).unbind("TextOutput",b)};d(document).bind("TextOutput",b)}(jQuery));function getUrlVars(){for(var d=[],b,a=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),c=0;c<a.length;c++){b=a[c].split("=");d.push(b[0]);d[b[0]]=b[1]}return d};
