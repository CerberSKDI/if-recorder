parchment.transcript={sessionId:(new Date).getTime()+""+Math.ceil(Math.random()*1E3),command:{input:"",timestamp:0},output:"",statusline:"",window:0,turncount:0,inputcount:0,outputcount:1,styles:"",saveUrl:"",story:"",optOut:typeof getUrlVars().feedback!="undefined"&&getUrlVars().feedback!="1",serverOffline:false,send:function(b,a,c){if(this.collectTranscripts()){if(typeof b!="undefined")this.window=b;if(typeof a!="undefined")this.styles=a;if(typeof c!="undefined")this.output=c;b=$.toJSON({session:this.sessionId,
log:{inputcount:this.inputcount,outputcount:this.outputcount,input:this.command.input,output:this.output,window:this.window,styles:this.styles,timestamp:(new Date).getTime()}});$.ajax({type:"POST",url:this.saveUrl,data:{data:b}});this.output="";this.outputcount++}},collectTranscripts:function(){if(this.saveUrl==""||this.optOut||this.serverOffline)return false;return true},initialize:function(b){if(typeof b=="string")this.saveUrl=b;if(this.story=="")this.story=parchment.options.default_story?parchment.options.default_story:
getUrlVars().story;if(!this.collectTranscripts())return false;b=$.toJSON({session:this.sessionId,start:{story:this.story,interpreter:"Parchment",browser:$.browser.name+" "+$.browser.version+" "+$.os.name}});$.ajax({type:"POST",url:this.saveUrl,data:{data:b},error:function(){this.serverOffline=true},success:function(a){this.serverOffline=a.toLowerCase()!="ok"}});return true},charName:function(b){switch(b){case 8:return"<backspace>";case 9:return"<tab>";case 13:return"<enter>";case 27:return"<esc>";
case 32:return"<space>";case 37:return"<left>";case 38:return"<up>";case 39:return"<right>";case 40:return"<down>";case 46:return"<del>";default:return String.fromCharCode(b)}},manualTranscriptMsg:"This story does not support saving transcripts manually."};
$(document).ready(function(){$(document).bind("LineInput",function(a){parchment.transcript.command=a;parchment.transcript.inputcount++});$(document).bind("CharInput",function(a){parchment.transcript.command=a;parchment.transcript.command.input=parchment.transcript.charName(a.input.keyCode);parchment.transcript.inputcount++});$(document).bind("TextOutput",function(a){a.output.window==0&&parchment.transcript.send(a.output.window,a.output.styles,a.output.text)});var b=function(){Console.prototype.renderHtml=
function(){for(var a="",c="",d=0;d<this.height;d++){for(var e=null,f=0;f<this.width;f++){if(this._styles[d][f]!==e){if(e!==null){parchment.transcript.send(1,e,c.replace(/\&nbsp\;/gi," "));c="";a+="</span>"}e=this._styles[d][f];if(e!==null)a+='<span class="'+e+'">'}a+=this._characters[d][f];c+=this._characters[d][f]}if(e!==null){a+="</span>";parchment.transcript.send(1,e,c.replace(/\&nbsp\;/gi," ")+"\n");c=""}a+="<br/>"}return a};parchment.vms.gnusto.onFlagsChanged=function(a,c){if(a)this.onPrint(parchment.transcript.manualTranscriptMsg);
this._isFixedWidth=c};$(document).unbind("TextOutput",b)};$(document).bind("TextOutput",b)});function getUrlVars(){for(var b=[],a,c=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),d=0;d<c.length;d++){a=c[d].split("=");b.push(a[0]);b[a[0]]=a[1]}return b};
